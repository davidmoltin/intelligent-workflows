{
  "workflow_id": "quote_expiration_management",
  "version": "1.0.0",
  "name": "Quote Expiration Management",
  "description": "Manage quote lifecycle with reminders and automatic expiration",
  "enabled": true,
  "tags": ["quote", "expiration", "lifecycle"],
  "trigger": {
    "type": "schedule",
    "cron": "0 */6 * * *"
  },
  "context": {
    "load": [
      "quote.details",
      "customer.profile"
    ]
  },
  "steps": [
    {
      "id": "check_reminder_needed",
      "type": "condition",
      "name": "Check if reminder should be sent",
      "condition": {
        "and": [
          {
            "field": "quote.hours_until_expiration",
            "operator": "lte",
            "value": 24
          },
          {
            "field": "quote.reminder_sent",
            "operator": "eq",
            "value": false
          }
        ]
      },
      "on_true": "send_reminder",
      "on_false": "check_expired"
    },
    {
      "id": "send_reminder",
      "type": "action",
      "name": "Send expiration reminder",
      "action": {
        "type": "execute"
      },
      "execute": [
        {
          "type": "notify",
          "recipients": ["{{quote.customer_email}}", "{{quote.sales_rep_email}}"],
          "message": "Quote {{quote.number}} for {{customer.name}} expires in {{quote.hours_until_expiration}} hours. View quote: {{quote.public_url}}"
        },
        {
          "type": "update_record",
          "entity": "quote",
          "entity_id": "{{quote.id}}",
          "data": {
            "reminder_sent": true,
            "reminder_sent_at": "{{now}}"
          }
        },
        {
          "type": "notify",
          "recipients": ["slack:#sales-notifications"],
          "message": "ðŸ“§ Expiration reminder sent for Quote {{quote.number}} - {{quote.hours_until_expiration}}h remaining"
        }
      ],
      "next": "check_expired"
    },
    {
      "id": "check_expired",
      "type": "condition",
      "name": "Check if quote has expired",
      "condition": {
        "field": "quote.hours_until_expiration",
        "operator": "lte",
        "value": 0
      },
      "on_true": "expire_quote",
      "on_false": "continue_monitoring"
    },
    {
      "id": "expire_quote",
      "type": "action",
      "name": "Mark quote as expired",
      "action": {
        "type": "execute"
      },
      "execute": [
        {
          "type": "update_record",
          "entity": "quote",
          "entity_id": "{{quote.id}}",
          "data": {
            "status": "expired",
            "expired_at": "{{now}}"
          }
        },
        {
          "type": "notify",
          "recipients": ["{{quote.sales_rep_email}}"],
          "message": "Quote {{quote.number}} for {{customer.name}} (total: ${{quote.total}}) has expired."
        },
        {
          "type": "webhook",
          "url": "{{integrations.crm.webhook_url}}",
          "method": "POST",
          "body": {
            "event": "quote_expired",
            "quote_id": "{{quote.id}}",
            "quote_number": "{{quote.number}}",
            "customer_id": "{{customer.id}}",
            "sales_rep_id": "{{quote.sales_rep_id}}"
          }
        },
        {
          "type": "create_record",
          "entity": "task",
          "data": {
            "title": "Follow up on expired quote {{quote.number}}",
            "description": "Quote {{quote.number}} for {{customer.name}} has expired. Follow up to see if customer is still interested.",
            "assigned_to": "{{quote.sales_rep_id}}",
            "due_date": "{{now_plus_24h}}",
            "priority": "medium",
            "related_entity": "quote",
            "related_entity_id": "{{quote.id}}"
          }
        }
      ],
      "next": "complete_workflow"
    },
    {
      "id": "continue_monitoring",
      "type": "action",
      "name": "Continue monitoring quote",
      "action": {
        "type": "allow"
      },
      "next": "complete_workflow"
    },
    {
      "id": "complete_workflow",
      "type": "action",
      "name": "Complete workflow",
      "action": {
        "type": "allow"
      }
    }
  ]
}
