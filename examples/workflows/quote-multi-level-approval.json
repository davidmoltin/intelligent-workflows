{
  "workflow_id": "quote_multi_level_approval",
  "version": "1.0.0",
  "name": "Quote Multi-Level Approval",
  "description": "Require sales rep review followed by sales manager approval for new quotes",
  "enabled": true,
  "tags": ["quote", "approval", "multi-level", "sales"],
  "trigger": {
    "type": "event",
    "event": "quote.created"
  },
  "context": {
    "load": [
      "quote.details",
      "quote.line_items",
      "customer.profile",
      "customer.order_history",
      "sales_rep.profile",
      "sales_manager.profile"
    ]
  },
  "steps": [
    {
      "id": "check_quote_value",
      "type": "condition",
      "name": "Check if quote requires approval",
      "condition": {
        "or": [
          {
            "field": "quote.total",
            "operator": "gte",
            "value": 5000
          },
          {
            "field": "quote.discount_percentage",
            "operator": "gt",
            "value": 15
          },
          {
            "field": "quote.has_custom_pricing",
            "operator": "eq",
            "value": true
          }
        ]
      },
      "on_true": "require_sales_rep_review",
      "on_false": "auto_approve_quote"
    },
    {
      "id": "require_sales_rep_review",
      "type": "action",
      "name": "Request sales rep review",
      "action": "block",
      "reason": "Quote requires sales rep review",
      "metadata": {
        "approval_level": "sales_rep_review",
        "approval_stage": 1,
        "total_stages": 2
      },
      "execute": [
        {
          "type": "create_approval_request",
          "entity": "quote",
          "entity_id": "{{quote.id}}",
          "approver_role": "sales_rep",
          "approver_id": "{{quote.assigned_sales_rep_id}}",
          "priority": "normal",
          "expires_in": "48h",
          "metadata": {
            "stage": "sales_rep_review",
            "quote_number": "{{quote.number}}",
            "customer_name": "{{customer.name}}",
            "quote_total": "{{quote.total}}",
            "discount_percentage": "{{quote.discount_percentage}}",
            "next_stage": "sales_manager_approval"
          }
        },
        {
          "type": "notify",
          "channel": "email",
          "recipients": ["{{sales_rep.email}}"],
          "template": "quote_rep_review_required",
          "data": {
            "quote_number": "{{quote.number}}",
            "customer_name": "{{customer.name}}",
            "quote_total": "{{quote.total}}",
            "discount_percentage": "{{quote.discount_percentage}}",
            "line_items_count": "{{quote.line_items.length}}",
            "review_url": "{{approval_url}}",
            "expires_at": "{{now + 48h}}"
          }
        },
        {
          "type": "notify",
          "channel": "slack",
          "recipients": ["{{sales_rep.slack_id}}"],
          "message": "üìã Quote {{quote.number}} requires your review - ${{quote.total}} for {{customer.name}}"
        },
        {
          "type": "update_record",
          "entity": "quote",
          "entity_id": "{{quote.id}}",
          "fields": {
            "status": "pending_rep_review",
            "review_requested_at": "{{now}}",
            "review_requested_by": "workflow_automation"
          }
        }
      ],
      "next": "wait_for_rep_decision"
    },
    {
      "id": "wait_for_rep_decision",
      "type": "wait",
      "name": "Wait for sales rep decision",
      "event": "quote.rep_reviewed",
      "timeout": "48h",
      "on_timeout": "handle_rep_review_timeout",
      "on_event": "check_rep_decision"
    },
    {
      "id": "handle_rep_review_timeout",
      "type": "action",
      "name": "Handle sales rep review timeout",
      "action": "execute",
      "execute": [
        {
          "type": "update_record",
          "entity": "quote",
          "entity_id": "{{quote.id}}",
          "fields": {
            "status": "rep_review_expired",
            "expired_at": "{{now}}"
          }
        },
        {
          "type": "notify",
          "channel": "email",
          "recipients": ["{{sales_rep.email}}", "{{sales_manager.email}}"],
          "template": "quote_rep_review_expired",
          "data": {
            "quote_number": "{{quote.number}}",
            "customer_name": "{{customer.name}}",
            "sales_rep_name": "{{sales_rep.name}}"
          }
        },
        {
          "type": "notify",
          "channel": "slack",
          "recipients": ["#sales-alerts"],
          "message": "‚ö†Ô∏è Quote {{quote.number}} review expired - Rep: {{sales_rep.name}}"
        }
      ],
      "next": "block_quote"
    },
    {
      "id": "check_rep_decision",
      "type": "condition",
      "name": "Check sales rep decision",
      "condition": {
        "field": "quote.rep_decision",
        "operator": "eq",
        "value": "approved"
      },
      "on_true": "require_manager_approval",
      "on_false": "handle_rep_rejection"
    },
    {
      "id": "handle_rep_rejection",
      "type": "action",
      "name": "Handle sales rep rejection",
      "action": "block",
      "reason": "Quote rejected by sales rep",
      "metadata": {
        "rejected_by": "sales_rep",
        "rejection_reason": "{{quote.rep_rejection_reason}}"
      },
      "execute": [
        {
          "type": "update_record",
          "entity": "quote",
          "entity_id": "{{quote.id}}",
          "fields": {
            "status": "rejected_by_rep",
            "rejected_at": "{{now}}",
            "rejected_by": "{{sales_rep.id}}",
            "rejection_reason": "{{quote.rep_rejection_reason}}"
          }
        },
        {
          "type": "notify",
          "channel": "email",
          "recipients": ["{{quote.created_by_email}}"],
          "template": "quote_rejected_by_rep",
          "data": {
            "quote_number": "{{quote.number}}",
            "customer_name": "{{customer.name}}",
            "sales_rep_name": "{{sales_rep.name}}",
            "rejection_reason": "{{quote.rep_rejection_reason}}"
          }
        }
      ]
    },
    {
      "id": "require_manager_approval",
      "type": "action",
      "name": "Request sales manager approval",
      "action": "block",
      "reason": "Quote requires sales manager approval",
      "metadata": {
        "approval_level": "sales_manager_approval",
        "approval_stage": 2,
        "total_stages": 2,
        "rep_approved_at": "{{now}}"
      },
      "execute": [
        {
          "type": "update_record",
          "entity": "quote",
          "entity_id": "{{quote.id}}",
          "fields": {
            "status": "pending_manager_approval",
            "rep_approved_at": "{{now}}",
            "rep_approved_by": "{{sales_rep.id}}",
            "rep_comments": "{{quote.rep_comments}}"
          }
        },
        {
          "type": "create_approval_request",
          "entity": "quote",
          "entity_id": "{{quote.id}}",
          "approver_role": "sales_manager",
          "approver_id": "{{sales_rep.manager_id}}",
          "priority": "high",
          "expires_in": "24h",
          "metadata": {
            "stage": "sales_manager_approval",
            "quote_number": "{{quote.number}}",
            "customer_name": "{{customer.name}}",
            "quote_total": "{{quote.total}}",
            "discount_percentage": "{{quote.discount_percentage}}",
            "reviewed_by_rep": "{{sales_rep.name}}",
            "rep_comments": "{{quote.rep_comments}}",
            "rep_approved_at": "{{now}}"
          }
        },
        {
          "type": "notify",
          "channel": "email",
          "recipients": ["{{sales_manager.email}}"],
          "cc": ["{{sales_rep.email}}"],
          "template": "quote_manager_approval_required",
          "data": {
            "quote_number": "{{quote.number}}",
            "customer_name": "{{customer.name}}",
            "quote_total": "{{quote.total}}",
            "discount_percentage": "{{quote.discount_percentage}}",
            "sales_rep_name": "{{sales_rep.name}}",
            "rep_comments": "{{quote.rep_comments}}",
            "approval_url": "{{approval_url}}",
            "expires_at": "{{now + 24h}}"
          }
        },
        {
          "type": "notify",
          "channel": "slack",
          "recipients": ["{{sales_manager.slack_id}}"],
          "message": "üîî Quote {{quote.number}} needs your approval - ${{quote.total}} (reviewed by {{sales_rep.name}})"
        }
      ],
      "next": "wait_for_manager_decision"
    },
    {
      "id": "wait_for_manager_decision",
      "type": "wait",
      "name": "Wait for sales manager decision",
      "event": "quote.manager_reviewed",
      "timeout": "24h",
      "on_timeout": "handle_manager_approval_timeout",
      "on_event": "check_manager_decision"
    },
    {
      "id": "handle_manager_approval_timeout",
      "type": "action",
      "name": "Handle sales manager approval timeout",
      "action": "execute",
      "execute": [
        {
          "type": "update_record",
          "entity": "quote",
          "entity_id": "{{quote.id}}",
          "fields": {
            "status": "manager_approval_expired",
            "expired_at": "{{now}}"
          }
        },
        {
          "type": "notify",
          "channel": "email",
          "recipients": ["{{sales_manager.email}}"],
          "cc": ["{{sales_rep.email}}"],
          "template": "quote_manager_approval_expired",
          "data": {
            "quote_number": "{{quote.number}}",
            "customer_name": "{{customer.name}}",
            "sales_manager_name": "{{sales_manager.name}}"
          }
        },
        {
          "type": "notify",
          "channel": "slack",
          "recipients": ["#sales-alerts"],
          "message": "‚ö†Ô∏è Quote {{quote.number}} manager approval expired - Manager: {{sales_manager.name}}"
        }
      ],
      "next": "block_quote"
    },
    {
      "id": "check_manager_decision",
      "type": "condition",
      "name": "Check sales manager decision",
      "condition": {
        "field": "quote.manager_decision",
        "operator": "eq",
        "value": "approved"
      },
      "on_true": "approve_quote",
      "on_false": "handle_manager_rejection"
    },
    {
      "id": "handle_manager_rejection",
      "type": "action",
      "name": "Handle sales manager rejection",
      "action": "block",
      "reason": "Quote rejected by sales manager",
      "metadata": {
        "rejected_by": "sales_manager",
        "rejection_reason": "{{quote.manager_rejection_reason}}"
      },
      "execute": [
        {
          "type": "update_record",
          "entity": "quote",
          "entity_id": "{{quote.id}}",
          "fields": {
            "status": "rejected_by_manager",
            "rejected_at": "{{now}}",
            "rejected_by": "{{sales_manager.id}}",
            "rejection_reason": "{{quote.manager_rejection_reason}}"
          }
        },
        {
          "type": "notify",
          "channel": "email",
          "recipients": ["{{sales_rep.email}}", "{{quote.created_by_email}}"],
          "template": "quote_rejected_by_manager",
          "data": {
            "quote_number": "{{quote.number}}",
            "customer_name": "{{customer.name}}",
            "sales_manager_name": "{{sales_manager.name}}",
            "rejection_reason": "{{quote.manager_rejection_reason}}"
          }
        },
        {
          "type": "notify",
          "channel": "slack",
          "recipients": ["#sales-notifications"],
          "message": "‚ùå Quote {{quote.number}} rejected by {{sales_manager.name}} - Reason: {{quote.manager_rejection_reason}}"
        }
      ]
    },
    {
      "id": "approve_quote",
      "type": "action",
      "name": "Approve quote and send to customer",
      "action": "allow",
      "metadata": {
        "approved_by": "sales_manager",
        "approval_chain": [
          {
            "level": "sales_rep",
            "approved_by": "{{sales_rep.id}}",
            "approved_at": "{{quote.rep_approved_at}}"
          },
          {
            "level": "sales_manager",
            "approved_by": "{{sales_manager.id}}",
            "approved_at": "{{now}}"
          }
        ]
      },
      "execute": [
        {
          "type": "update_record",
          "entity": "quote",
          "entity_id": "{{quote.id}}",
          "fields": {
            "status": "approved",
            "approved_at": "{{now}}",
            "approved_by": "{{sales_manager.id}}",
            "manager_comments": "{{quote.manager_comments}}",
            "ready_to_send": true
          }
        },
        {
          "type": "notify",
          "channel": "email",
          "recipients": ["{{sales_rep.email}}"],
          "template": "quote_fully_approved",
          "data": {
            "quote_number": "{{quote.number}}",
            "customer_name": "{{customer.name}}",
            "quote_total": "{{quote.total}}",
            "sales_manager_name": "{{sales_manager.name}}",
            "manager_comments": "{{quote.manager_comments}}",
            "send_to_customer_url": "{{quote.send_url}}"
          }
        },
        {
          "type": "notify",
          "channel": "slack",
          "recipients": ["#sales-wins"],
          "message": "‚úÖ Quote {{quote.number}} fully approved! ${{quote.total}} for {{customer.name}} - Ready to send to customer"
        },
        {
          "type": "webhook",
          "url": "{{integrations.crm.webhook_url}}",
          "method": "POST",
          "body": {
            "event": "quote_approved",
            "quote_id": "{{quote.id}}",
            "quote_number": "{{quote.number}}",
            "customer_id": "{{customer.id}}",
            "total": "{{quote.total}}",
            "approved_by": "{{sales_manager.id}}",
            "approved_at": "{{now}}"
          }
        }
      ]
    },
    {
      "id": "auto_approve_quote",
      "type": "action",
      "name": "Auto-approve quote (below threshold)",
      "action": "allow",
      "metadata": {
        "auto_approved": true,
        "reason": "Quote below approval threshold"
      },
      "execute": [
        {
          "type": "update_record",
          "entity": "quote",
          "entity_id": "{{quote.id}}",
          "fields": {
            "status": "approved",
            "approved_at": "{{now}}",
            "approved_by": "workflow_automation",
            "auto_approved": true,
            "ready_to_send": true
          }
        },
        {
          "type": "notify",
          "channel": "email",
          "recipients": ["{{quote.created_by_email}}"],
          "template": "quote_auto_approved",
          "data": {
            "quote_number": "{{quote.number}}",
            "customer_name": "{{customer.name}}",
            "quote_total": "{{quote.total}}",
            "send_to_customer_url": "{{quote.send_url}}"
          }
        }
      ]
    },
    {
      "id": "block_quote",
      "type": "action",
      "name": "Block quote (failed approval)",
      "action": "block",
      "reason": "Quote approval process failed or expired"
    }
  ]
}
