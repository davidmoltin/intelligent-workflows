{
  "workflow_id": "quote_multi_level_approval",
  "version": "1.0.0",
  "name": "Quote Multi-Level Approval",
  "description": "Require sales rep review followed by sales manager approval for new quotes",
  "enabled": true,
  "tags": ["quote", "approval", "multi-level", "sales"],
  "trigger": {
    "type": "event",
    "event": "quote.created"
  },
  "context": {
    "load": [
      "quote.details",
      "quote.line_items",
      "customer.profile",
      "customer.order_history",
      "sales_rep.profile",
      "sales_manager.profile"
    ]
  },
  "steps": [
    {
      "id": "check_quote_value",
      "type": "condition",
      "name": "Check if quote requires approval",
      "condition": {
        "or": [
          {
            "field": "quote.total",
            "operator": "gte",
            "value": 5000
          },
          {
            "field": "quote.discount_percentage",
            "operator": "gt",
            "value": 15
          },
          {
            "field": "quote.has_custom_pricing",
            "operator": "eq",
            "value": true
          }
        ]
      },
      "on_true": "require_sales_rep_review",
      "on_false": "auto_approve_quote"
    },
    {
      "id": "require_sales_rep_review",
      "type": "action",
      "name": "Request sales rep review",
      "action": {
        "type": "require_approval",
        "reason": "Quote requires sales rep review"
      },
      "execute": [
        {
          "type": "create_approval_request",
          "entity": "quote",
          "entity_id": "{{quote.id}}",
          "data": {
            "approver_role": "sales_rep",
            "reason": "Quote requires sales rep review before manager approval",
            "expires_in": "48h",
            "stage": "sales_rep_review",
            "quote_number": "{{quote.number}}",
            "customer_name": "{{customer.name}}",
            "quote_total": "{{quote.total}}",
            "discount_percentage": "{{quote.discount_percentage}}",
            "next_stage": "sales_manager_approval"
          }
        },
        {
          "type": "notify",
          "recipients": ["{{sales_rep.email}}"],
          "message": "Quote {{quote.number}} requires your review - ${{quote.total}} for {{customer.name}}. Discount: {{quote.discount_percentage}}%, Items: {{quote.line_items.length}}"
        },
        {
          "type": "notify",
          "recipients": ["slack:{{sales_rep.slack_id}}"],
          "message": "üìã Quote {{quote.number}} requires your review - ${{quote.total}} for {{customer.name}}"
        },
        {
          "type": "update_record",
          "entity": "quote",
          "entity_id": "{{quote.id}}",
          "data": {
            "status": "pending_rep_review",
            "review_requested_at": "{{now}}",
            "review_requested_by": "workflow_automation"
          }
        }
      ],
      "next": "wait_for_rep_decision"
    },
    {
      "id": "wait_for_rep_decision",
      "type": "wait",
      "name": "Wait for sales rep decision",
      "wait": {
        "event": "quote.rep_reviewed",
        "timeout": "48h"
      },
      "next": "check_rep_decision"
    },
    {
      "id": "check_rep_decision",
      "type": "condition",
      "name": "Check sales rep decision",
      "condition": {
        "field": "quote.rep_decision",
        "operator": "eq",
        "value": "approved"
      },
      "on_true": "require_manager_approval",
      "on_false": "handle_rep_rejection"
    },
    {
      "id": "handle_rep_rejection",
      "type": "action",
      "name": "Handle sales rep rejection",
      "action": {
        "type": "block",
        "reason": "Quote rejected by sales rep: {{quote.rep_rejection_reason}}"
      },
      "execute": [
        {
          "type": "update_record",
          "entity": "quote",
          "entity_id": "{{quote.id}}",
          "data": {
            "status": "rejected_by_rep",
            "rejected_at": "{{now}}",
            "rejected_by": "{{sales_rep.id}}",
            "rejection_reason": "{{quote.rep_rejection_reason}}"
          }
        },
        {
          "type": "notify",
          "recipients": ["{{quote.created_by_email}}"],
          "message": "Quote {{quote.number}} for {{customer.name}} was rejected by {{sales_rep.name}}. Reason: {{quote.rep_rejection_reason}}"
        }
      ]
    },
    {
      "id": "require_manager_approval",
      "type": "action",
      "name": "Request sales manager approval",
      "action": {
        "type": "require_approval",
        "reason": "Quote requires sales manager approval (Stage 2 of 2)"
      },
      "execute": [
        {
          "type": "update_record",
          "entity": "quote",
          "entity_id": "{{quote.id}}",
          "data": {
            "status": "pending_manager_approval",
            "rep_approved_at": "{{now}}",
            "rep_approved_by": "{{sales_rep.id}}",
            "rep_comments": "{{quote.rep_comments}}"
          }
        },
        {
          "type": "create_approval_request",
          "entity": "quote",
          "entity_id": "{{quote.id}}",
          "data": {
            "approver_role": "sales_manager",
            "reason": "Quote approved by sales rep, requires manager final approval",
            "expires_in": "24h",
            "stage": "sales_manager_approval",
            "quote_number": "{{quote.number}}",
            "customer_name": "{{customer.name}}",
            "quote_total": "{{quote.total}}",
            "discount_percentage": "{{quote.discount_percentage}}",
            "reviewed_by_rep": "{{sales_rep.name}}",
            "rep_comments": "{{quote.rep_comments}}",
            "rep_approved_at": "{{now}}"
          }
        },
        {
          "type": "notify",
          "recipients": ["{{sales_manager.email}}", "{{sales_rep.email}}"],
          "message": "Quote {{quote.number}} needs manager approval - ${{quote.total}} for {{customer.name}}. Reviewed by {{sales_rep.name}}: {{quote.rep_comments}}"
        },
        {
          "type": "notify",
          "recipients": ["slack:{{sales_manager.slack_id}}"],
          "message": "üîî Quote {{quote.number}} needs your approval - ${{quote.total}} (reviewed by {{sales_rep.name}})"
        }
      ],
      "next": "wait_for_manager_decision"
    },
    {
      "id": "wait_for_manager_decision",
      "type": "wait",
      "name": "Wait for sales manager decision",
      "wait": {
        "event": "quote.manager_reviewed",
        "timeout": "24h"
      },
      "next": "check_manager_decision"
    },
    {
      "id": "check_manager_decision",
      "type": "condition",
      "name": "Check sales manager decision",
      "condition": {
        "field": "quote.manager_decision",
        "operator": "eq",
        "value": "approved"
      },
      "on_true": "approve_quote",
      "on_false": "handle_manager_rejection"
    },
    {
      "id": "handle_manager_rejection",
      "type": "action",
      "name": "Handle sales manager rejection",
      "action": {
        "type": "block",
        "reason": "Quote rejected by sales manager: {{quote.manager_rejection_reason}}"
      },
      "execute": [
        {
          "type": "update_record",
          "entity": "quote",
          "entity_id": "{{quote.id}}",
          "data": {
            "status": "rejected_by_manager",
            "rejected_at": "{{now}}",
            "rejected_by": "{{sales_manager.id}}",
            "rejection_reason": "{{quote.manager_rejection_reason}}"
          }
        },
        {
          "type": "notify",
          "recipients": ["{{sales_rep.email}}", "{{quote.created_by_email}}"],
          "message": "Quote {{quote.number}} for {{customer.name}} was rejected by {{sales_manager.name}}. Reason: {{quote.manager_rejection_reason}}"
        },
        {
          "type": "notify",
          "recipients": ["slack:#sales-notifications"],
          "message": "‚ùå Quote {{quote.number}} rejected by {{sales_manager.name}} - Reason: {{quote.manager_rejection_reason}}"
        }
      ]
    },
    {
      "id": "approve_quote",
      "type": "action",
      "name": "Approve quote and send to customer",
      "action": {
        "type": "allow"
      },
      "execute": [
        {
          "type": "update_record",
          "entity": "quote",
          "entity_id": "{{quote.id}}",
          "data": {
            "status": "approved",
            "approved_at": "{{now}}",
            "approved_by": "{{sales_manager.id}}",
            "manager_comments": "{{quote.manager_comments}}",
            "ready_to_send": true
          }
        },
        {
          "type": "notify",
          "recipients": ["{{sales_rep.email}}"],
          "message": "Quote {{quote.number}} fully approved by {{sales_manager.name}}! ${{quote.total}} for {{customer.name}}. Manager comments: {{quote.manager_comments}}. Ready to send to customer."
        },
        {
          "type": "notify",
          "recipients": ["slack:#sales-wins"],
          "message": "‚úÖ Quote {{quote.number}} fully approved! ${{quote.total}} for {{customer.name}} - Ready to send to customer"
        },
        {
          "type": "webhook",
          "url": "{{integrations.crm.webhook_url}}",
          "method": "POST",
          "body": {
            "event": "quote_approved",
            "quote_id": "{{quote.id}}",
            "quote_number": "{{quote.number}}",
            "customer_id": "{{customer.id}}",
            "total": "{{quote.total}}",
            "approved_by": "{{sales_manager.id}}",
            "approved_at": "{{now}}"
          }
        }
      ]
    },
    {
      "id": "auto_approve_quote",
      "type": "action",
      "name": "Auto-approve quote (below threshold)",
      "action": {
        "type": "allow"
      },
      "execute": [
        {
          "type": "update_record",
          "entity": "quote",
          "entity_id": "{{quote.id}}",
          "data": {
            "status": "approved",
            "approved_at": "{{now}}",
            "approved_by": "workflow_automation",
            "auto_approved": true,
            "ready_to_send": true
          }
        },
        {
          "type": "notify",
          "recipients": ["{{quote.created_by_email}}"],
          "message": "Quote {{quote.number}} for {{customer.name}} (${{quote.total}}) was auto-approved and is ready to send to customer."
        }
      ]
    }
  ]
}
