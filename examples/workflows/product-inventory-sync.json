{
  "workflow_id": "product_inventory_sync",
  "version": "1.0.0",
  "name": "Product Inventory Synchronization",
  "description": "Sync inventory across warehouses and prevent overselling",
  "enabled": true,
  "tags": ["product", "inventory", "warehouse"],
  "trigger": {
    "type": "event",
    "event": "product.inventory.changed"
  },
  "context": {
    "load": [
      "product.details",
      "product.inventory_all_warehouses",
      "product.pending_orders",
      "product.reorder_settings"
    ]
  },
  "steps": [
    {
      "id": "check_low_stock",
      "type": "condition",
      "name": "Check if inventory is below reorder point",
      "condition": {
        "field": "product.available_quantity",
        "operator": "lte",
        "value": "{{product.reorder_settings.reorder_point}}"
      },
      "on_true": "trigger_reorder",
      "on_false": "check_oversell_risk"
    },
    {
      "id": "trigger_reorder",
      "type": "action",
      "name": "Trigger automatic reorder",
      "action": {
        "type": "execute"
      },
      "execute": [
        {
          "type": "webhook",
          "url": "{{integrations.erp.webhook_url}}",
          "method": "POST",
          "body": {
            "event": "reorder_required",
            "product_id": "{{product.id}}",
            "product_sku": "{{product.sku}}",
            "current_quantity": "{{product.available_quantity}}",
            "reorder_quantity": "{{product.reorder_settings.reorder_quantity}}",
            "supplier_id": "{{product.reorder_settings.preferred_supplier}}"
          }
        },
        {
          "type": "create_record",
          "entity": "purchase_order",
          "data": {
            "product_id": "{{product.id}}",
            "quantity": "{{product.reorder_settings.reorder_quantity}}",
            "supplier_id": "{{product.reorder_settings.preferred_supplier}}",
            "status": "draft",
            "created_by": "workflow_automation"
          }
        },
        {
          "type": "notify",
          "recipients": ["role:inventory_manager"],
          "message": "Low stock alert: {{product.name}} ({{product.sku}}) - Current: {{product.available_quantity}}, Reorder point: {{product.reorder_settings.reorder_point}}"
        }
      ],
      "next": "check_oversell_risk"
    },
    {
      "id": "check_oversell_risk",
      "type": "condition",
      "name": "Check if there's risk of overselling",
      "condition": {
        "field": "product.available_quantity",
        "operator": "lte",
        "value": 0
      },
      "on_true": "prevent_overselling",
      "on_false": "update_inventory_status"
    },
    {
      "id": "prevent_overselling",
      "type": "action",
      "name": "Block further sales of this product",
      "action": {
        "type": "execute"
      },
      "execute": [
        {
          "type": "update_record",
          "entity": "product",
          "entity_id": "{{product.id}}",
          "data": {
            "available_for_sale": false,
            "out_of_stock": true,
            "updated_at": "{{now}}",
            "updated_by": "workflow_automation"
          }
        },
        {
          "type": "webhook",
          "url": "{{integrations.storefront.webhook_url}}",
          "method": "POST",
          "body": {
            "event": "product_out_of_stock",
            "product_id": "{{product.id}}",
            "product_sku": "{{product.sku}}"
          }
        },
        {
          "type": "notify",
          "recipients": ["slack:#inventory-alerts"],
          "message": "⚠️ Product {{product.sku}} - {{product.name}} is now OUT OF STOCK"
        }
      ],
      "next": "allow_workflow"
    },
    {
      "id": "update_inventory_status",
      "type": "action",
      "name": "Update product inventory status",
      "action": {
        "type": "execute"
      },
      "execute": [
        {
          "type": "update_record",
          "entity": "product",
          "entity_id": "{{product.id}}",
          "data": {
            "available_for_sale": true,
            "out_of_stock": false,
            "updated_at": "{{now}}"
          }
        },
        {
          "type": "webhook",
          "url": "{{integrations.storefront.webhook_url}}",
          "method": "POST",
          "body": {
            "event": "product_inventory_updated",
            "product_id": "{{product.id}}",
            "product_sku": "{{product.sku}}",
            "available_quantity": "{{product.available_quantity}}"
          }
        }
      ],
      "next": "allow_workflow"
    },
    {
      "id": "allow_workflow",
      "type": "action",
      "name": "Complete workflow successfully",
      "action": {
        "type": "allow"
      }
    }
  ]
}
